rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuth() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function hasPermission(perm) {
      let roleId = getUserRole();
      return roleId == 'admin' ||
             get(/databases/$(database)/documents/roles/$(roleId)).data.permissions.hasAny([perm]);
    }

    function isAdmin() {
      return isAuth() && getUserRole() == 'admin';
    }

    // --- 1. SYSTEM CONFIGURATION ---

    match /roles/{roleId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /users/{userId} {
      allow create: if request.auth.uid == userId;
      allow read: if isAuth();
      allow update: if isAdmin() || (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
    }

    match /invited_emails/{inviteId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_users');
    }

    // --- 2. MASTER DATA (New Schema) ---
    
    match /master_ingredients/{ingId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('edit_inventory');
    }

    match /master_products/{productId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('edit_inventory');
    }
    
    match /master_partners/{partnerId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_partners');
    }

    // --- 3. TRANSACTION DATA (New Schema) ---

    // Unified Inventory Log
    match /inventory_transactions/{transId} {
      allow read: if isAuth();
      // Only created by trusted logic (Server or via functions), but for client-side app:
      // Allow write if user has permission to perform the action causing the stock move.
      // Broadly: 'manage_inventory' or 'create_order' or 'create_production'.
      // For simplicity in Rules:
      allow create: if isAuth();
      allow update, delete: if isAdmin(); // History should be immutable mostly
    }

    // Sales Orders
    match /sales_orders/{orderId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('create_order') || hasPermission('manage_orders');
    }

    // Production Runs (Keep as a "Plan" or "Batch" record, linked to inventory logs)
    match /production_runs/{runId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('create_production');
    }

    // Imports (Keep as "Receipt" record, linked to inventory logs)
    match /imports/{importId} {
        allow read: if isAuth();
        allow write: if isAdmin() || hasPermission('manage_imports');
    }

    // Finance
    match /finance_ledger/{entryId} {
        allow read: if isAuth() && (isAdmin() || hasPermission('view_finance'));
        allow write: if isAdmin() || hasPermission('manage_expenses') || hasPermission('create_order');
    }

    // --- 4. LEGACY / AUX ---
    match /assets/{assetId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_assets');
    }

    match /expense_categories/{catId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_expenses');
    }

    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuth();
    }

    match /{document=**} {
      allow read, write: if false; 
    }
  }
}

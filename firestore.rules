rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuth() {
      return request.auth != null;
    }

    // Fetch User's Role ID (e.g. 'admin', 'manager')
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // --- DYNAMIC PERMISSION CHECK ---
    // Checks if the user's role has the specific permission in the 'roles' collection.
    // Fallback: If 'admin', always true.
    function hasPermission(perm) {
      let roleId = getUserRole();
      return roleId == 'admin' ||
             get(/databases/$(database)/documents/roles/$(roleId)).data.permissions.hasAny([perm]);
    }

    // Legacy Helpers (Optional, but useful for bootstrapping if roles collection is empty)
    // We will rely on hasPermission() primarily, but for initial setup (when roles might be missing),
    // we might need a fallback. However, let's enforce the new system.
    // If 'roles' doc is missing, get() fails -> Deny access.
    // This is secure. Admin is excepted above.

    function isAdmin() {
      return isAuth() && getUserRole() == 'admin';
    }

    // --- 1. SYSTEM CONFIGURATION ---

    // ROLES: Configurable Permissions
    // Admin manages roles. Authenticated users read to know their rights.
    match /roles/{roleId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // USERS: Profile & Role Assignment
    match /users/{userId} {
      allow create: if request.auth.uid == userId;
      allow read: if isAuth();
      // Only Admin changes roles. User can update profile (but not role).
      allow update: if isAdmin() || (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
    }

    // INVITES
    match /invited_emails/{inviteId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_users');
    }

    // --- 2. MASTER DATA ---
    
    // Ingredients: View(Inventory), Edit(Inventory)
    match /ingredients/{ingId} {
      allow read: if isAuth(); // Or hasPermission('view_inventory')
      allow write: if isAdmin() || hasPermission('edit_inventory');
    }

    // Products: View(Inventory), Edit(Inventory)
    match /products/{productId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('edit_inventory');
    }
    
    // Partners: View(Sales/Partners), Edit(Partners)
    match /partners/{partnerId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_partners');
    }

    // Assets: View(Inventory/Assets), Edit(Assets)
    match /assets/{assetId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_assets');
    }

    // Expense Categories
    match /expense_categories/{catId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_expenses');
    }

    // --- 3. TRANSACTION DATA ---

    // Imports: Manage(Imports) -> Creates stock
    match /imports/{importId} {
      allow read: if isAuth(); // History view
      allow write: if isAdmin() || hasPermission('manage_imports');
    }

    // Production: Create(Production)
    match /production_runs/{prodRunId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('create_production');
    }
    
    // Orders: Create(Order) / Manage(Order)
    match /orders/{orderId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('create_order') || hasPermission('manage_orders');
    }

    // Expenses Log: Manage(Expenses)
     match /expenses_log/{logId} {
      allow read: if isAuth();
      allow write: if isAdmin() || hasPermission('manage_expenses');
    }

    // Stocktake Logs: Edit(Inventory) -> Result of stocktake
    match /stocktake_logs/{logId} {
      allow read: if isAuth();
      allow create: if isAdmin() || hasPermission('edit_inventory') || hasPermission('manage_assets');
    }

    // --- 4. SYSTEM LOGS ---
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuth();
    }

    // --- 5. CATCH-ALL ---
    match /{document=**} {
      allow read, write: if false; 
    }
  }
}
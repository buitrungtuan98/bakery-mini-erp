rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuth() {
      return request.auth != null;
    }

    // Lấy role từ document của user
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuth() && getUserRole() == 'admin';
    }

    function isManager() {
      return isAuth() && (getUserRole() == 'manager' || getUserRole() == 'admin');
    }

    function isSales() {
      return isAuth() && (getUserRole() == 'sales' || getUserRole() == 'admin');
    }

    // --- 1. COLLECTION: users (Quản lý User & Role) ---
    match /users/{userId} {
      // User tự tạo doc của mình khi login lần đầu
      allow create: if request.auth.uid == userId;
      // Ai cũng đọc được để lấy thông tin role (được cache ở client)
      allow read: if isAuth();
      // Chỉ Admin mới được update role của người khác
      allow update: if isAdmin() || (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
    }

    // --- COLLECTION: invited_emails (Hệ thống mời) ---
    match /invited_emails/{inviteId} {
      // Admin tạo lời mời
      allow read: if isAuth(); // Cho phép đọc để kiểm tra khi login
      allow write: if isAdmin();
      // Cho phép xóa khi user đã đăng ký thành công (logic này xử lý ở client hoặc cloud function,
      // ở đây ta cho phép isAuth delete nếu email khớp với email của họ - hơi khó check, nên để Admin hoặc backend xử lý.
      // Tạm thời để isAdmin write, client login check read)
    }

    // --- 2. MASTER DATA (Ingredients, Products, Partners) ---
    
    // Manager & Admin được sửa NVL, Thành phẩm
    match /ingredients/{ingId} {
      allow read: if isAuth();
      allow write: if isManager();
    }

    match /products/{productId} {
      allow read: if isAuth();
      allow write: if isManager();
    }
    
    // Sales & Admin được sửa Khách hàng/NCC (Partner)
    // Manager cũng cần tạo NCC khi nhập hàng
    match /partners/{partnerId} {
      allow read: if isAuth();
      allow write: if isSales() || isManager();
    }

    // --- 3. TRANSACTION DATA (Imports, Production, Orders) ---

    // Imports: Manager & Admin
    match /imports/{importId} {
      allow read: if isAuth();
      allow write: if isManager();
    }

    // Production: Manager & Admin
    match /production_runs/{prodRunId} {
      allow read: if isAuth();
      allow write: if isManager();
    }
    
    // Orders: Sales & Admin
    match /orders/{orderId} {
      allow read: if isAuth();
      allow write: if isSales();
    }

    // Expenses Log: Admin & Manager
     match /expenses_log/{logId} {
      allow read: if isAuth();
      allow write: if isManager();
    }

    // --- 4. SYSTEM LOGS ---
    match /audit_logs/{logId} {
      allow read: if isAdmin(); // Chỉ Admin xem log
      allow create: if isAuth(); // Ai cũng được ghi log hành động của mình
    }

    // --- 5. CATCH-ALL ---
    match /{document=**} {
      allow read, write: if false; 
    }
  }
}